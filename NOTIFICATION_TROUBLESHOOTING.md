# üîî –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

## ‚ùì –ü–æ—á–µ–º—É —è –Ω–µ –ø–æ–ª—É—á–∞—é —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è?

### –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:

1. **–í—ã –Ω–µ –ø–æ–¥–ø–∏—Å–∞–Ω—ã –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è**
2. **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ —Å–æ–∑–¥–∞—é—Ç—Å—è** (–Ω–µ—Ç —Å–æ–±—ã—Ç–∏–π)
3. **–ü—Ä–æ–±–ª–µ–º–∞ —Å API** (–±–æ—Ç –Ω–µ –º–æ–∂–µ—Ç –ø–æ–ª—É—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è)
4. **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è** (–ø—Ä–æ–±–ª–µ–º–∞ —Å –æ—Ç–ø—Ä–∞–≤–∫–æ–π)

---

## üîç –ü–æ—à–∞–≥–æ–≤–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:

### –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É

**–í –±–æ—Ç–µ:**
```
/start
‚Üí –ù–∞–∂–º–∏—Ç–µ "üîî –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è"
```

**–ò–ª–∏ —á–µ—Ä–µ–∑ –∫–æ–º–∞–Ω–¥—É:**
```
/test_notification
‚Üí –ü—Ä–æ–≤–µ—Ä–∏—Ç –ø–æ–¥–ø–∏—Å–∫—É –∏ —Å–æ–∑–¥–∞—Å—Ç —Ç–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
```

### –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –≤—ã –ø–æ–¥–ø–∏—Å–∞–Ω—ã —á–µ—Ä–µ–∑ SQL:

```bash
# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ
docker compose exec postgres psql -U sendbuddy -d sendbuddy -c "
SELECT 
  tu.telegram_id,
  tu.first_name,
  tu.subscribed,
  ts.active as subscription_active,
  ts.subscription_type
FROM telegram_users tu
LEFT JOIN telegram_subscriptions ts ON tu.telegram_id = ts.telegram_id
WHERE tu.telegram_id = 8401704531;
"
```

**–î–æ–ª–∂–Ω–æ –±—ã—Ç—å:**
- `subscribed = TRUE`
- `subscription_active = TRUE`

### –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ –ë–î:

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ –≤–∞—à–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
docker compose exec postgres psql -U sendbuddy -d sendbuddy -c "
SELECT 
  id,
  type,
  title,
  message,
  sent,
  created_at
FROM telegram_notifications
WHERE telegram_id = 8401704531
ORDER BY created_at DESC
LIMIT 10;
"
```

### –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:

```bash
# –ù–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
docker compose exec postgres psql -U sendbuddy -d sendbuddy -c "
SELECT COUNT(*) as unsent_count
FROM telegram_notifications
WHERE telegram_id = 8401704531 AND sent = FALSE;
"
```

### –®–∞–≥ 5: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–±–æ—Ç—É API:

```bash
# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ
curl http://localhost:3001/api/telegram/subscribers | jq

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–∞—à–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ API
curl http://localhost:3001/api/telegram/notifications/8401704531 | jq
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ß–µ—Ä–µ–∑ –∫–æ–º–∞–Ω–¥—É –±–æ—Ç–∞ (–¥–ª—è –∞–¥–º–∏–Ω–æ–≤)

```
/test_notification
```

–≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞:
- ‚úÖ –°–æ–∑–¥–∞—Å—Ç —Ç–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç –≤–∞—à—É –ø–æ–¥–ø–∏—Å–∫—É
- ‚úÖ –ü–æ–∫–∞–∂–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ß–µ—Ä–µ–∑ API (–Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ)

```bash
curl -X POST http://localhost:3001/api/telegram/test-notification \
  -H "Content-Type: application/json" \
  -d '{"telegramId": 8401704531}'
```

---

## ‚úÖ –ö–æ–≥–¥–∞ —Å–æ–∑–¥–∞—é—Ç—Å—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:

–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è –∫–æ–≥–¥–∞:

1. **–ü–æ—è–≤–ª—è–µ—Ç—Å—è –Ω–æ–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ** ‚Üí –í—Å–µ –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ–ª—É—á–∞—é—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
2. **–í–∞—Å –Ω–∞–∑–Ω–∞—á–∞—é—Ç –∫—É—Ä—å–µ—Ä–æ–º** ‚Üí –í—ã –ø–æ–ª—É—á–∞–µ—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
3. **–ò–∑–º–µ–Ω—è–µ—Ç—Å—è —Å—Ç–∞—Ç—É—Å –∑–∞–¥–∞–Ω–∏—è** ‚Üí –û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å –∏ –∫—É—Ä—å–µ—Ä –ø–æ–ª—É—á–∞—é—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
4. **–ü—Ä–∏—Ö–æ–¥–∏—Ç –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ** ‚Üí –î—Ä—É–≥–æ–π —É—á–∞—Å—Ç–Ω–∏–∫ –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
5. **–ü–µ—Ä–µ–≤–æ–¥—è—Ç—Å—è –¥–µ–Ω—å–≥–∏** ‚Üí –ö—É—Ä—å–µ—Ä –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
6. **–ü–æ–ª—É—á–µ–Ω –æ—Ç–∑—ã–≤** ‚Üí –í—ã –ø–æ–ª—É—á–∞–µ—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ

---

## üîß –ö–∞–∫ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—ã:

### –ü—Ä–æ–±–ª–µ–º–∞ 1: –í—ã –Ω–µ –ø–æ–¥–ø–∏—Å–∞–Ω—ã

**–†–µ—à–µ–Ω–∏–µ:**
1. –û—Ç–ø—Ä–∞–≤—å—Ç–µ `/start` –≤ –±–æ—Ç–µ
2. –ù–∞–∂–º–∏—Ç–µ "üîî –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è"
3. –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É `/subscribe` (–µ—Å–ª–∏ –µ—Å—Ç—å)

### –ü—Ä–æ–±–ª–µ–º–∞ 2: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Å–æ–∑–¥–∞—é—Ç—Å—è, –Ω–æ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è

**–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –±–æ—Ç–∞:**
```bash
docker compose logs telegram-bot --tail=100 | grep -i notification
```

**–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ notification service —Ä–∞–±–æ—Ç–∞–µ—Ç:**
```bash
docker compose logs telegram-bot | grep "Notification service started"
```

### –ü—Ä–æ–±–ª–µ–º–∞ 3: API –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

**–ü—Ä–æ–≤–µ—Ä—å—Ç–µ endpoint:**
```bash
curl http://localhost:3001/api/telegram/notifications/8401704531
```

**–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ backend:**
```bash
docker compose logs backend --tail=50 | grep notification
```

### –ü—Ä–æ–±–ª–µ–º–∞ 4: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ —Å–æ–∑–¥–∞—é—Ç—Å—è –ø—Ä–∏ —Å–æ–±—ã—Ç–∏—è—Ö

**–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ —Å–æ–±—ã—Ç–∏—è –ø—Ä–æ–∏—Å—Ö–æ–¥—è—Ç:**
- –°–æ–∑–¥–∞–π—Ç–µ —Ç–µ—Å—Ç–æ–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ
- –ù–∞–∑–Ω–∞—á—å—Ç–µ —Å–µ–±—è –∫—É—Ä—å–µ—Ä–æ–º
- –ò–∑–º–µ–Ω–∏—Ç–µ —Å—Ç–∞—Ç—É—Å –∑–∞–¥–∞–Ω–∏—è

**–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ backend –Ω–∞ –æ—à–∏–±–∫–∏:**
```bash
docker compose logs backend --tail=100 | grep -i error
```

---

## üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ SQL (–¥–µ—Ç–∞–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞):

### 1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –≤—ã –≤ —Å–∏—Å—Ç–µ–º–µ:

```sql
SELECT * FROM telegram_users WHERE telegram_id = 8401704531;
```

### 2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–ø–∏—Å–∫–∏:

```sql
SELECT * FROM telegram_subscriptions WHERE telegram_id = 8401704531;
```

### 3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤—Å–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:

```sql
SELECT 
  id,
  type,
  title,
  sent,
  created_at,
  sent_at
FROM telegram_notifications
WHERE telegram_id = 8401704531
ORDER BY created_at DESC;
```

### 4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ:

```sql
SELECT COUNT(*) 
FROM telegram_notifications 
WHERE telegram_id = 8401704531 AND sent = FALSE;
```

### 5. –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–æ–∑–¥–∞–π—Ç–µ —Ç–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ:

```sql
INSERT INTO telegram_notifications (telegram_id, type, title, message, data)
VALUES (
  8401704531,
  'new_task',
  'üß™ –¢–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ',
  '–≠—Ç–æ —Ç–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ. –ï—Å–ª–∏ –≤—ã –≤–∏–¥–∏—Ç–µ –µ–≥–æ, –∑–Ω–∞—á–∏—Ç —Å–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç!',
  '{"test": true}'::jsonb
);
```

–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –ø–æ–¥–æ–∂–¥–∏—Ç–µ 30 —Å–µ–∫—É–Ω–¥ - —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –ø—Ä–∏–π—Ç–∏.

---

## üöÄ –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞:

```bash
# 1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É
docker compose exec postgres psql -U sendbuddy -d sendbuddy -c "
SELECT 
  tu.telegram_id,
  tu.subscribed,
  COUNT(ts.id) as active_subscriptions
FROM telegram_users tu
LEFT JOIN telegram_subscriptions ts ON tu.telegram_id = ts.telegram_id AND ts.active = TRUE
WHERE tu.telegram_id = 8401704531
GROUP BY tu.telegram_id, tu.subscribed;
"

# 2. –°–æ–∑–¥–∞–π—Ç–µ —Ç–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
docker compose exec postgres psql -U sendbuddy -d sendbuddy -c "
INSERT INTO telegram_notifications (telegram_id, type, title, message)
VALUES (8401704531, 'new_task', 'üß™ –¢–µ—Å—Ç', '–¢–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ');
"

# 3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –æ–Ω–æ —Å–æ–∑–¥–∞–ª–æ—Å—å
docker compose exec postgres psql -U sendbuddy -d sendbuddy -c "
SELECT * FROM telegram_notifications 
WHERE telegram_id = 8401704531 
ORDER BY created_at DESC 
LIMIT 1;
"

# 4. –ü–æ–¥–æ–∂–¥–∏—Ç–µ 30 —Å–µ–∫—É–Ω–¥ –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –±–æ—Ç–∞
docker compose logs telegram-bot --tail=20 | grep -i notification
```

---

## ‚úÖ –ß–µ–∫–ª–∏—Å—Ç:

- [ ] –í—ã –ø–æ–¥–ø–∏—Å–∞–Ω—ã –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (`subscribed = TRUE`)
- [ ] –ê–∫—Ç–∏–≤–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ –µ—Å—Ç—å (`telegram_subscriptions.active = TRUE`)
- [ ] –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Å–æ–∑–¥–∞—é—Ç—Å—è –≤ –ë–î
- [ ] Notification service –∑–∞–ø—É—â–µ–Ω (–ª–æ–≥–∏ –±–æ—Ç–∞)
- [ ] API endpoint —Ä–∞–±–æ—Ç–∞–µ—Ç (`/telegram/notifications/:telegramId`)
- [ ] –ë–æ—Ç –º–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è

---

## üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:

1. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É `/test_notification`** –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
2. **–ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ –ª–æ–≥–∏** –µ—Å–ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ –ø—Ä–∏—Ö–æ–¥—è—Ç
3. **–°–æ–∑–¥–∞–π—Ç–µ —Ç–µ—Å—Ç–æ–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ** —á—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π
4. **–£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –ø–æ–¥–ø–∏—Å–∞–Ω—ã** —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É "üîî –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è"

---

## üìù –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

1. –û–±–Ω–æ–≤–∏—Ç–µ –±–æ—Ç–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
2. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `/test_notification` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
3. –°–æ–∑–¥–∞–π—Ç–µ —Ç–µ—Å—Ç–æ–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏—Ö–æ–¥—è—Ç

